<div class="analysis-container">

    <ng-template #loadingSpinner>

        <mat-card>

            <mat-card-content>

                <div class="spinner">
                    <mat-spinner color="accent" [diameter]="30"></mat-spinner>
                </div>

            </mat-card-content>

        </mat-card>

    </ng-template>

    <ng-template #reportHome>

        <div *ngIf="!ss.loading; else loadingSpinner">

            <div *ngIf="ss.ready; else noReport">

                <mat-card>

                    <mat-card-content>

                        <p class="card-title">Select a report from the side</p>

                    </mat-card-content>

                </mat-card>

            </div>

        </div>

    </ng-template>

    <ng-template #noReport class="spinner">

        <mat-card>

            <mat-card-content>

                <p class="spinner">There's Nothing Here...</p>

            </mat-card-content>

        </mat-card>

    </ng-template>

    <div *ngIf="fightId !== 0; else reportHome">

        <div *ngIf="ss.ready; else noReport">

            <div *ngIf="analysis.$ready | async; else loadingSpinner" class="card-container" #infoCard>

                <mat-card>

                    <mat-card-header>

                        <mat-card-title class="p-0 m-0">
                            Participants
                        </mat-card-title>

                    </mat-card-header>

                    <hr class="my-1 mt-2" />

                    <mat-card-content >

                        <mat-grid-list cols="8" rowHeight="3:1" gutterSize="2px">

                            <mat-grid-tile *ngFor="let player of ss.fightPlayerMap.get(fightId)" [ngClass]="{'active mat-elevation-z6': player.id === activePlayer.id}"
                                (click)="activePlayer = player; renderHpChart()">

                                <mat-icon [svgIcon]="jobList[player.type.toLowerCase()].short"></mat-icon>

                            </mat-grid-tile>

                        </mat-grid-list>

                        <ng-template #iconList let-info>

                            <p class="mb-2 mt-3">{{info.title}}</p>

                            <div class="icon-container" *ngIf="(jobList[activePlayer.type.toLowerCase()].defensive | abilityFilter: info.filter).length !== 0">

                                <div *ngFor="let key of jobList[activePlayer.type.toLowerCase()].defensive | abilityFilter: info.filter" class="ability-icon-container">

                                    <span [matTooltip]="skillList[key.toLowerCase()].desc" [matTooltipClass]="'ability-tooltip'">

                                        <img [src]="getIcon(skillList[key.toLowerCase()].path)" class="ability-icon mat-elevation-z6"
                                            [ngClass]="{'ability-unused': analysis.mitigationTableMap.get(activePlayer.id).get(key.toLowerCase()) === undefined,
                                            'ability-active': activeSkillMap.get(activePlayer.id) === key.toLowerCase()}"
                                            (click)="onAbilityClick(key)" alt="Ability Icon">

                                    </span>

                                </div>

                            </div>

                        </ng-template>

                        <div *ngIf="jobList[activePlayer.type.toLowerCase()]">

                            <div class="content-display row mt-3">

                                <div class="raidwide-container col">

                                    <ng-container *ngTemplateOutlet="iconList; context: { $implicit: { title: 'Single Target', filter: 'b' } }">
                                    </ng-container>

                                </div>

                                <div class="personal-container col">

                                    <ng-container *ngTemplateOutlet="iconList; context: { $implicit: { title: 'Party', filter: 'a' } }">
                                    </ng-container>

                                </div>

                            </div>

                            <div class="content-display row">

                                <div class="healing-container col">

                                    <ng-container *ngTemplateOutlet="iconList; context: { $implicit: { title: 'Healing', filter: 'c' } }">
                                    </ng-container>

                                </div>
                            </div>

                            <div id="chartContainer" class="chart-container mt-3"></div>

                        </div>

                    </mat-card-content>

                </mat-card>

                <mat-card>

                    <mat-card-header>

                        <mat-card-title class="p-0 m-0">
                            Damage Sources
                        </mat-card-title>

                        <mat-slide-toggle class="p-0 m-0" (change)="showMinor = !showMinor" style="margin-left: auto!important">
                            Show Minor
                        </mat-slide-toggle>

                    </mat-card-header>

                    <hr class="my-1 mt-2">

                    <mat-card-content class="event-container">

                        <mat-accordion>

                            <mat-expansion-panel *ngFor="let mechanic of analysis.mechanics | minorFilter: showMinor">

                                <mat-expansion-panel-header>
                                    {{analysis.mechanicMap.get(mechanic).name}}
                                </mat-expansion-panel-header>

                                    
                                <mat-card *ngFor="let instance of analysis.mechanicMap.get(mechanic).timestamps" class="m-1 mx-0">

                                    <mat-card-subtitle>
                                        <p class="p-0 m-0">

                                            ({{toFightTime(analysis.fight.start_time, instance)}})

                                        </p>
                                    </mat-card-subtitle>

                                    <mat-card-content>

                                        <table mat-table [dataSource]="analysis.mechanicMap.get(mechanic).eventMap.get(instance) | jobSort">

                                            <ng-container matColumnDef="player">

                                                <th mat-header-cell *matHeaderCellDef>Player</th>
                                                <td mat-cell *matCellDef="let event">

                                                    <mat-icon [svgIcon]="jobList[ss.fightPlayerIdMap.get(analysis.fight.id).get(event.targetID).type.toLowerCase()].short"></mat-icon>

                                                    {{ss.fightPlayerIdMap.get(analysis.fight.id).get(event.targetID).name}}

                                                </td>

                                            </ng-container>

                                            <ng-container matColumnDef="damage-taken">

                                                <th mat-header-cell *matHeaderCellDef> Damage Taken </th>
                                                <td mat-cell *matCellDef="let event"> {{event.amount}} </td>

                                            </ng-container>

                                            <tr mat-header-row *matHeaderRowDef="['player', 'damage-taken']"></tr>
                                            <tr mat-row *matRowDef="let row; columns: ['player', 'damage-taken']"></tr>

                                        </table>

                                    </mat-card-content>

                                </mat-card>

                            </mat-expansion-panel>

                        </mat-accordion>

                    </mat-card-content>

                </mat-card>
            </div>
        </div>
    </div>
</div>